--[[
    ULTIMATE ITEM DUPER - FIXED VERSION
    DUPE ITEM APA SAJA DARI BACKPACK!
]]

-- Bagian 1: Pemuat Rayfield UI
local Rayfield
local success, errorMessage = pcall(function()
    local source = game:HttpGet("https://sirius.menu/rayfield")
    Rayfield = loadstring(source)()
end)

if not success then
    warn("Gagal memuat Rayfield: " .. tostring(errorMessage))
    return
end

-- Layanan
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local localPlayer = Players.LocalPlayer

-- Fungsi Notifikasi
local function updateStatus(msg)
    if Rayfield then
        Rayfield:Notify({Title = "ULTIMATE DUPER", Content = msg, Duration = 6})
    end
    print("[ULTIMATE DUPER] " .. msg)
end

-- ================================================================================= --
--[[ BAGIAN 2: ULTIMATE DUPER SYSTEM ]]
-- ================================================================================= --

local UltimateDuper = {
    Active = false,
    BackpackItems = {},
    SelectedItem = nil,
    DupeAmount = 5
}

-- FUNCTION 1: SCAN BACKPACK UNTUK SEMUA ITEM
function UltimateDuper:ScanBackpack()
    updateStatus("ğŸ” SCANNING BACKPACK...")
    
    self.BackpackItems = {}
    local itemCount = 0
    
    local backpack = localPlayer:FindFirstChild("Backpack")
    if not backpack then
        updateStatus("âŒ Backpack tidak ditemukan!")
        return {}
    end
    
    -- Scan semua item di backpack
    local function scanFolder(folder, path)
        for _, item in pairs(folder:GetChildren()) do
            if item:IsA("Tool") then
                itemCount = itemCount + 1
                local itemInfo = {
                    Object = item,
                    Name = item.Name,
                    Class = item.ClassName,
                    Path = path .. "/" .. item.Name,
                    HasHandle = item:FindFirstChild("Handle") ~= nil,
                    ScriptCount = 0
                }
                
                -- Hitung scripts
                for _, child in pairs(item:GetDescendants()) do
                    if child:IsA("Script") or child:IsA("LocalScript") then
                        itemInfo.ScriptCount = itemInfo.ScriptCount + 1
                    end
                end
                
                table.insert(self.BackpackItems, itemInfo)
                updateStatus("ğŸ“¦ " .. itemInfo.Name .. " (" .. itemInfo.Class .. ") - Handle: " .. tostring(itemInfo.HasHandle))
            elseif item:IsA("Folder") then
                scanFolder(item, path .. "/" .. item.Name)
            end
        end
    end
    
    scanFolder(backpack, "Backpack")
    updateStatus("âœ… Found " .. itemCount .. " items in backpack!")
    
    -- Update UI dropdown
    self:UpdateItemDropdown()
    
    return self.BackpackItems
end

-- FUNCTION 2: UPDATE DROPDOWN ITEMS
function UltimateDuper:UpdateItemDropdown()
    local itemNames = {}
    for _, itemInfo in pairs(self.BackpackItems) do
        table.insert(itemNames, itemInfo.Name)
    end
    
    if #itemNames == 0 then
        table.insert(itemNames, "No items found")
    end
    
    -- Update dropdown di UI
    if DuperTab then
        -- Hapus dropdown lama dan buat baru
        for i, v in pairs(DuperTab:GetElements()) do
            if v.Name == "ItemDropdown" then
                DuperTab:RemoveElement(v)
                break
            end
        end
        
        DuperTab:CreateDropdown({
            Name = "ğŸ“¦ Pilih Item untuk Dupe",
            Options = itemNames,
            Flag = "ItemDropdown",
            Callback = function(Option)
                UltimateDuper.SelectedItem = Option
                updateStatus("ğŸ¯ Selected: " .. Option)
            end
        })
    end
end

-- FUNCTION 3: DEEP CLONE ITEM
function UltimateDuper:DeepCloneItem(originalItem, newName)
    updateStatus("ğŸ­ CLONING: " .. originalItem.Name)
    
    local success, clonedItem = pcall(function()
        -- Deep clone dengan semua descendants
        local clone = originalItem:Clone()
        
        if newName then
            clone.Name = newName
        else
            clone.Name = originalItem.Name .. "_COPY"
        end
        
        -- Anti-detection measures
        clone:SetAttribute("Duplicated", true)
        clone:SetAttribute("OriginalName", originalItem.Name)
        
        return clone
    end)
    
    if success then
        updateStatus("âœ… Success cloning: " .. originalItem.Name)
        return clonedItem
    else
        updateStatus("âŒ Failed to clone: " .. originalItem.Name)
        return nil
    end
end

-- FUNCTION 4: MASS DUPER ENGINE
function UltimateDuper:MassDupeEngine(itemName, amount)
    if self.Active then
        updateStatus("âš ï¸ Duper sedang aktif, tunggu...")
        return
    end
    
    self.Active = true
    updateStatus("ğŸš€ STARTING MASS DUPE: " .. itemName .. " x" .. amount)
    
    -- Cari item di backpack
    local targetItem = nil
    for _, itemInfo in pairs(self.BackpackItems) do
        if itemInfo.Name == itemName then
            targetItem = itemInfo.Object
            break
        end
    end
    
    if not targetItem then
        updateStatus("âŒ Item tidak ditemukan: " .. itemName)
        self.Active = false
        return 0
    end
    
    local successCount = 0
    local failedCount = 0
    
    -- Proses dupe sebanyak amount
    for i = 1, amount do
        updateStatus("ğŸ”„ Dupe [" .. i .. "/" .. amount .. "] " .. itemName)
        
        local clone = self:DeepCloneItem(targetItem, itemName .. "_DUPED_" .. i)
        
        if clone then
            -- Add ke backpack
            local added = pcall(function()
                clone.Parent = localPlayer.Backpack
                return true
            end)
            
            if added then
                successCount = successCount + 1
                updateStatus("âœ… Dupe success: " .. itemName .. " #" .. i)
            else
                failedCount = failedCount + 1
                updateStatus("âŒ Failed to add: " .. itemName .. " #" .. i)
            end
        else
            failedCount = failedCount + 1
        end
        
        -- Delay untuk avoid detection
        task.wait(0.1)
    end
    
    -- Result
    updateStatus("\nğŸ‰ DUPE COMPLETE!")
    updateStatus("ğŸ“Š Success: " .. successCount .. "/" .. amount)
    updateStatus("ğŸ’” Failed: " .. failedCount .. "/" .. amount)
    
    if successCount > 0 then
        updateStatus("ğŸ’° TOTAL DUPED: " .. successCount .. " " .. itemName)
    end
    
    self.Active = false
    return successCount
end

-- FUNCTION 5: SMART DUPER
function UltimateDuper:SmartDupe(itemName, amount)
    updateStatus("ğŸ§  SMART DUPER: " .. itemName .. " x" .. amount)
    
    -- Scan backpack dulu jika belum
    if #self.BackpackItems == 0 then
        self:ScanBackpack()
    end
    
    -- Cek jika item ada
    local itemExists = false
    for _, itemInfo in pairs(self.BackpackItems) do
        if itemInfo.Name == itemName then
            itemExists = true
            break
        end
    end
    
    if not itemExists then
        updateStatus("âŒ Item tidak ada di backpack: " .. itemName)
        return 0
    end
    
    -- Gunakan mass dupe engine
    return self:MassDupeEngine(itemName, amount)
end

-- FUNCTION 6: BATCH DUPER
function UltimateDuper:BatchDupe(itemsList)
    if self.Active then return 0 end
    
    self.Active = true
    updateStatus("ğŸ¯ STARTING BATCH DUPE...")
    
    local totalSuccess = 0
    local totalItems = 0
    
    for itemName, amount in pairs(itemsList) do
        if type(amount) == "number" and amount > 0 then
            totalItems = totalItems + 1
            updateStatus("\nğŸ”„ Processing: " .. itemName .. " x" .. amount)
            
            local success = self:SmartDupe(itemName, amount)
            totalSuccess = totalSuccess + success
            
            task.wait(1) -- Delay antar items
        end
    end
    
    updateStatus("\nğŸŠ BATCH DUPE COMPLETE!")
    updateStatus("ğŸ“¦ Total items processed: " .. totalItems)
    updateStatus("ğŸ’° Total duplicates created: " .. totalSuccess)
    
    self.Active = false
    return totalSuccess
end

-- FUNCTION 7: BACKPACK CLEANER
function UltimateDuper:CleanDuplicatedItems()
    updateStatus("ğŸ§¹ CLEANING DUPED ITEMS...")
    
    local backpack = localPlayer:FindFirstChild("Backpack")
    if not backpack then
        updateStatus("âŒ Backpack tidak ditemukan!")
        return 0
    end
    
    local removedCount = 0
    
    local function cleanFolder(folder)
        for _, item in pairs(folder:GetChildren()) do
            if item:IsA("Tool") then
                if item:GetAttribute("Duplicated") == true or string.find(item.Name, "_DUPED_") then
                    item:Destroy()
                    removedCount = removedCount + 1
                end
            elseif item:IsA("Folder") then
                cleanFolder(item)
            end
        end
    end
    
    cleanFolder(backpack)
    updateStatus("âœ… Removed " .. removedCount .. " duped items")
    
    return removedCount
end

-- ================================================================================= --
--[[ BAGIAN 3: ULTIMATE DUPER UI ]]
-- ================================================================================= --

local Window = Rayfield:CreateWindow({
    Name = "ğŸ’° ULTIMATE ITEM DUPER",
    LoadingTitle = "Loading Duper Engine...",
    LoadingSubtitle = "DUPE ITEM APA SAJA!",
    Theme = "Default",
    ToggleUIKeybind = "K"
})

-- TAB UTAMA: DUPER
local DuperTab = Window:CreateTab("ğŸ’° Item Duper")
DuperTab:CreateLabel("DUPE ITEM APA SAJA DARI BACKPACK!")

-- Dropdown akan dibuat setelah scan
local itemDropdown = DuperTab:CreateDropdown({
    Name = "ğŸ“¦ Pilih Item untuk Dupe",
    Options = {"Scan backpack dulu..."},
    Flag = "ItemDropdown",
    Callback = function(Option)
        UltimateDuper.SelectedItem = Option
        updateStatus("ğŸ¯ Selected: " .. Option)
    end
})

DuperTab:CreateButton({
    Name = "ğŸ” Scan Backpack Items",
    Callback = function()
        UltimateDuper:ScanBackpack()
    end
})

DuperTab:CreateSection("Quick Dupe")

-- Input untuk jumlah dupe
DuperTab:CreateInput({
    Name = "ğŸ”¢ Jumlah Dupe",
    PlaceholderText = "Contoh: 5",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        local amount = tonumber(Text)
        if amount and amount > 0 then
            UltimateDuper.DupeAmount = amount
            updateStatus("ğŸ“Š Dupe amount: " .. amount)
        else
            updateStatus("âŒ Jumlah harus angka positif!")
        end
    end
})

DuperTab:CreateButton({
    Name = "ğŸš€ DUPE ITEM!",
    Callback = function()
        if not UltimateDuper.SelectedItem or UltimateDuper.SelectedItem == "Scan backpack dulu..." then
            updateStatus("âŒ Pilih item dulu!")
            return
        end
        
        if UltimateDuper.DupeAmount <= 0 then
            updateStatus("âŒ Set jumlah dupe dulu!")
            return
        end
        
        UltimateDuper:SmartDupe(UltimateDuper.SelectedItem, UltimateDuper.DupeAmount)
    end
})

DuperTab:CreateSection("Mass Dupe")

DuperTab:CreateButton({
    Name = "ğŸ’° Dupe All Items x3",
    Callback = function()
        if #UltimateDuper.BackpackItems == 0 then
            UltimateDuper:ScanBackpack()
        end
        
        local itemsList = {}
        for _, itemInfo in pairs(UltimateDuper.BackpackItems) do
            itemsList[itemInfo.Name] = 3
        end
        
        if next(itemsList) then
            UltimateDuper:BatchDupe(itemsList)
        else
            updateStatus("âŒ Tidak ada items di backpack!")
        end
    end
})

DuperTab:CreateButton({
    Name = "ğŸ’ Dupe Rare Items x5",
    Callback = function()
        if #UltimateDuper.BackpackItems == 0 then
            UltimateDuper:ScanBackpack()
        end
        
        local rareItems = {}
        for _, itemInfo in pairs(UltimateDuper.BackpackItems) do
            -- Item dianggap rare jika punya handle atau banyak scripts
            if itemInfo.HasHandle or itemInfo.ScriptCount > 0 then
                rareItems[itemInfo.Name] = 5
            end
        end
        
        if next(rareItems) then
            UltimateDuper:BatchDupe(rareItems)
        else
            updateStatus("âŒ Tidak ada rare items ditemukan!")
        end
    end
})

-- TAB: BACKPACK MANAGER
local BackpackTab = Window:CreateTab("ğŸ’ Backpack Manager")
BackpackTab:CreateLabel("Backpack Management & Tools")

BackpackTab:CreateButton({
    Name = "ğŸ“‹ List All Backpack Items",
    Callback = function()
        updateStatus("ğŸ“‹ BACKPACK ITEMS:")
        
        if #UltimateDuper.BackpackItems == 0 then
            UltimateDuper:ScanBackpack()
        end
        
        for i, itemInfo in pairs(UltimateDuper.BackpackItems) do
            updateStatus(i .. ". " .. itemInfo.Name .. 
                        " | Handle: " .. tostring(itemInfo.HasHandle) ..
                        " | Scripts: " .. itemInfo.ScriptCount)
        end
    end
})

BackpackTab:CreateButton({
    Name = "ğŸ§¹ Clean Duped Items",
    Callback = function()
        UltimateDuper:CleanDuplicatedItems()
    end
})

BackpackTab:CreateButton({
    Name = "ğŸ”„ Refresh Backpack",
    Callback = function()
        local character = localPlayer.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:UnequipTools()
                updateStatus("âœ… Backpack refreshed!")
                
                -- Rescan setelah refresh
                task.wait(1)
                UltimateDuper:ScanBackpack()
            end
        end
    end
})

-- TAB: ADVANCED DUPER
local AdvancedTab = Window:CreateTab("âš¡ Advanced Duper")
AdvancedTab:CreateLabel("Advanced Duplication Tools")

AdvancedTab:CreateButton({
    Name = "âš¡ Ultra Mass Dupe x50",
    Callback = function()
        if not UltimateDuper.SelectedItem or UltimateDuper.SelectedItem == "Scan backpack dulu..." then
            updateStatus("âŒ Pilih item dulu di tab Duper!")
            return
        end
        
        updateStatus("âš¡ ULTRA MASS DUPE 50x: " .. UltimateDuper.SelectedItem)
        UltimateDuper:MassDupeEngine(UltimateDuper.SelectedItem, 50)
    end
})

AdvancedTab:CreateButton({
    Name = "ğŸ¯ Custom Item Dupe",
    Callback = function()
        AdvancedTab:CreateInput({
            Name = "Item Name",
            PlaceholderText = "Masukkan nama item exact",
            Callback = function(itemName)
                if itemName and itemName ~= "" then
                    AdvancedTab:CreateInput({
                        Name = "Jumlah Dupe",
                        PlaceholderText = "Masukkan jumlah",
                        Callback = function(amountText)
                            local amount = tonumber(amountText)
                            if amount and amount > 0 then
                                UltimateDuper:SmartDupe(itemName, amount)
                            else
                                updateStatus("âŒ Jumlah harus angka positif!")
                            end
                        end
                    })
                end
            end
        })
    end
})

-- Inisialisasi
updateStatus("ğŸ’° ULTIMATE ITEM DUPER LOADED!")
updateStatus("ğŸ¯ Klik 'Scan Backpack Items' dulu!")
updateStatus("ğŸ’¡ Lalu pilih item dan set jumlah dupe!")

-- Auto scan setelah 3 detik
task.spawn(function()
    task.wait(3)
    updateStatus("ğŸ” Auto scanning backpack...")
    UltimateDuper:ScanBackpack()
end)

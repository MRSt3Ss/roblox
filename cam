--[[
    FISH IT REAL ROD CLONER
    CLONE ROD ASLI DARI GAME + PROPER SETUP
]]

-- Bagian 1: Pemuat Rayfield UI
local Rayfield
local success, errorMessage = pcall(function()
    local source = game:HttpGet("https://sirius.menu/rayfield")
    Rayfield = loadstring(source)()
end)

if not success then
    warn("Gagal memuat Rayfield: " .. tostring(errorMessage))
    return
end

-- Layanan
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local localPlayer = Players.LocalPlayer

-- Fungsi Notifikasi
local function updateStatus(msg)
    if Rayfield then
        Rayfield:Notify({Title = "REAL ROD CLONER", Content = msg, Duration = 8})
    end
    print("[ROD CLONER] " .. msg)
end

-- ================================================================================= --
--[[ BAGIAN 2: REAL ROD CLONING SYSTEM ]]
-- ================================================================================= --

local RodCloner = {
    Active = false,
    ClonedRods = {},
    AvailableRods = {
        "Basic Rod",
        "Party Rod", 
        "Piranha Rod",
        "Shark Rod",
        "Golden Rod",
        "Dragon Rod",
        "Ice Rod",
        "Lava Rod",
        "Rainbow Rod",
        "VIP Rod"
    }
}

-- FUNCTION 1: FIND REAL ROD TEMPLATES
function RodCloner:FindRealRodTemplates()
    updateStatus("ğŸ” MENCARI ROD TEMPLATES ASLI...")
    
    local templates = {}
    
    -- Cari di ReplicatedStorage
    pcall(function()
        for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
            if obj:IsA("Tool") and string.find(string.lower(obj.Name), "rod") then
                templates[obj.Name] = obj
                updateStatus("âœ… Template ditemukan: " .. obj.Name)
            end
        end
    end)
    
    -- Cari di Workspace (kadang rod ada di sini)
    pcall(function()
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("Tool") and string.find(string.lower(obj.Name), "rod") then
                templates[obj.Name] = obj
                updateStatus("âœ… Template di Workspace: " .. obj.Name)
            end
        end
    end)
    
    -- Cari di StarterPack/StarterGui
    pcall(function()
        local starterPack = game:GetService("StarterPack")
        local starterPlayer = game:GetService("StarterPlayer")
        
        for _, obj in pairs(starterPack:GetDescendants()) do
            if obj:IsA("Tool") and string.find(string.lower(obj.Name), "rod") then
                templates[obj.Name] = obj
                updateStatus("âœ… Template di StarterPack: " .. obj.Name)
            end
        end
    end)
    
    return templates
end

-- FUNCTION 2: ANALYZE ROD STRUCTURE
function RodCloner:AnalyzeRodStructure(rodTemplate)
    updateStatus("ğŸ”¬ ANALYZING ROD: " .. rodTemplate.Name)
    
    local structure = {
        Handle = nil,
        Scripts = {},
        Configs = {},
        Parts = {},
        Meshes = {}
    }
    
    -- Cari Handle
    structure.Handle = rodTemplate:FindFirstChild("Handle")
    if structure.Handle then
        updateStatus("   ğŸ”§ Handle: ADA")
    else
        updateStatus("   âŒ Handle: TIDAK ADA")
    end
    
    -- Cari Scripts
    for _, script in pairs(rodTemplate:GetDescendants()) do
        if script:IsA("Script") or script:IsA("LocalScript") then
            table.insert(structure.Scripts, script)
        elseif script:IsA("Configuration") then
            table.insert(structure.Configs, script)
        elseif script:IsA("Part") then
            table.insert(structure.Parts, script.Name)
        elseif script:IsA("MeshPart") then
            table.insert(structure.Meshes, script.Name)
        end
    end
    
    updateStatus("   ğŸ“œ Scripts: " .. #structure.Scripts)
    updateStatus("   âš™ï¸ Configs: " .. #structure.Configs)
    updateStatus("   ğŸ§± Parts: " .. #structure.Parts)
    updateStatus("   ğŸ¨ Meshes: " .. #structure.Meshes)
    
    return structure
end

-- FUNCTION 3: CREATE PROPER ROD FROM TEMPLATE
function RodCloner:CreateRodFromTemplate(rodName, template)
    updateStatus("ğŸ­ CREATING ROD: " .. rodName)
    
    local success = pcall(function()
        -- Clone dari template
        local newRod = template:Clone()
        newRod.Name = rodName
        newRod.Parent = nil
        
        -- Setup proper properties
        newRod.Enabled = true
        newRod.CanBeDropped = false
        newRod.RequiresHandle = true
        
        -- Pastikan Handle ada
        if not newRod:FindFirstChild("Handle") then
            updateStatus("   âš ï¸ Membuat Handle manual...")
            local handle = Instance.new("Part")
            handle.Name = "Handle"
            handle.Size = Vector3.new(1, 4, 1)
            handle.Parent = newRod
        end
        
        -- Add ke Backpack
        local backpack = localPlayer:FindFirstChild("Backpack")
        if not backpack then
            backpack = Instance.new("Folder")
            backpack.Name = "Backpack"
            backpack.Parent = localPlayer
        end
        
        -- Cari atau buat Rods folder
        local rodsFolder = backpack:FindFirstChild("Rods")
        if not rodsFolder then
            rodsFolder = Instance.new("Folder")
            rodsFolder.Name = "Rods"
            rodsFolder.Parent = backpack
        end
        
        newRod.Parent = rodsFolder
        updateStatus("   âœ… Rod dibuat: " .. rodName)
        
        return newRod
    end)
    
    if success then
        table.insert(self.ClonedRods, rodName)
        return true
    else
        updateStatus("   âŒ Gagal membuat rod: " .. rodName)
        return false
    end
end

-- FUNCTION 4: CREATE CUSTOM ROD (jika template tidak ada)
function RodCloner:CreateCustomRod(rodName)
    updateStatus("ğŸ¨ CREATING CUSTOM ROD: " .. rodName)
    
    local success = pcall(function()
        -- Buat Tool
        local rodTool = Instance.new("Tool")
        rodTool.Name = rodName
        rodTool.ToolTip = rodName
        rodTool.CanBeDropped = false
        rodTool.Enabled = true
        rodTool.RequiresHandle = true
        
        -- Buat Handle
        local handle = Instance.new("Part")
        handle.Name = "Handle"
        handle.Size = Vector3.new(0.5, 6, 0.5) -- Ukuran pancingan
        handle.BrickColor = BrickColor.new("Bright blue")
        handle.Material = Enum.Material.Plastic
        handle.Parent = rodTool
        
        -- Buat Mesh untuk handle (bentuk pancingan)
        local mesh = Instance.new("CylinderMesh")
        mesh.Parent = handle
        
        -- Buat Attachment untuk fishing line
        local attachment = Instance.new("Attachment")
        attachment.Name = "FishingLine"
        attachment.Position = Vector3.new(0, -3, 0) -- Di ujung pancingan
        attachment.Parent = handle
        
        -- Basic fishing script
        local script = Instance.new("Script")
        script.Name = "FishingScript"
        script.Source = [[
            -- Basic Fishing Script
            local tool = script.Parent
            local handle = tool:WaitForChild("Handle")
            
            tool.Activated:Connect(function()
                print("Fishing with: " .. tool.Name)
            end)
            
            tool.Equipped:Connect(function()
                print("Equipped: " .. tool.Name)
            end)
        ]]
        script.Parent = rodTool
        
        -- Add ke Backpack
        local backpack = localPlayer:FindFirstChild("Backpack")
        if not backpack then
            backpack = Instance.new("Folder")
            backpack.Name = "Backpack"
            backpack.Parent = localPlayer
        end
        
        local rodsFolder = backpack:FindFirstChild("Rods")
        if not rodsFolder then
            rodsFolder = Instance.new("Folder")
            rodsFolder.Name = "Rods"
            rodsFolder.Parent = backpack
        end
        
        rodTool.Parent = rodsFolder
        updateStatus("   âœ… Custom rod dibuat: " .. rodName)
        
        return rodTool
    end)
    
    if success then
        table.insert(self.ClonedRods, rodName)
        return true
    else
        updateStatus("   âŒ Gagal membuat custom rod: " .. rodName)
        return false
    end
end

-- FUNCTION 5: BACKPACK MANAGER
function RodCloner:SetupBackpackManager()
    updateStatus("ğŸ’ SETUP BACKPACK MANAGER...")
    
    pcall(function()
        -- Pastikan Backpack ada
        local backpack = localPlayer:FindFirstChild("Backpack")
        if not backpack then
            backpack = Instance.new("Folder")
            backpack.Name = "Backpack"
            backpack.Parent = localPlayer
            updateStatus("   âœ… Backpack dibuat")
        else
            updateStatus("   âœ… Backpack sudah ada")
        end
        
        -- Buat Rods folder
        local rodsFolder = backpack:FindFirstChild("Rods")
        if not rodsFolder then
            rodsFolder = Instance.new("Folder")
            rodsFolder.Name = "Rods"
            rodsFolder.Parent = backpack
            updateStatus("   âœ… Rods folder dibuat")
        else
            updateStatus("   âœ… Rods folder sudah ada")
        end
        
        -- Clean up invalid rods
        for _, item in pairs(rodsFolder:GetChildren()) do
            if item:IsA("Tool") then
                if not item:FindFirstChild("Handle") then
                    updateStatus("   ğŸ—‘ï¸ Removing invalid rod: " .. item.Name)
                    item:Destroy()
                end
            end
        end
    end)
end

-- FUNCTION 6: CLONE OR CREATE ROD
function RodCloner:CloneOrCreateRod(rodName)
    updateStatus("ğŸ¯ PROCESSING: " .. rodName)
    
    -- Cari template dulu
    local templates = self:FindRealRodTemplates()
    
    -- Coba cari template yang cocok
    local template = nil
    for templateName, templateObj in pairs(templates) do
        if string.find(string.lower(templateName), string.lower(rodName)) then
            template = templateObj
            break
        end
    end
    
    -- Jika tidak ada, cari basic rod
    if not template then
        template = templates["Basic Rod"] or templates["Rod"]
    end
    
    if template then
        updateStatus("   ğŸ“‹ Menggunakan template: " .. template.Name)
        return self:CreateRodFromTemplate(rodName, template)
    else
        updateStatus("   âš ï¸ Template tidak ditemukan, buat custom")
        return self:CreateCustomRod(rodName)
    end
end

-- FUNCTION 7: MASS ROD CREATION
function RodCloner:CreateAllRods()
    if self.Active then return end
    
    self.Active = true
    self.ClonedRods = {}
    
    updateStatus("ğŸš€ STARTING MASS ROD CREATION...")
    
    -- Setup backpack dulu
    self:SetupBackpackManager()
    task.wait(1)
    
    -- Cari templates
    local templates = self:FindRealRodTemplates()
    task.wait(1)
    
    -- Buat semua rods
    local successCount = 0
    
    for i, rodName in ipairs(self.AvailableRods) do
        updateStatus("\nğŸ› ï¸ [" .. i .. "/" .. #self.AvailableRods .. "] " .. rodName)
        
        local success = self:CloneOrCreateRod(rodName)
        
        if success then
            successCount = successCount + 1
            updateStatus("ğŸ‰ BERHASIL: " .. rodName)
        else
            updateStatus("ğŸ’” GAGAL: " .. rodName)
        end
        
        task.wait(0.5)
    end
    
    -- Final Result
    updateStatus("\nğŸ“Š FINAL RESULT:")
    updateStatus("âœ… Success: " .. successCount .. "/" .. #self.AvailableRods)
    
    if #self.ClonedRods > 0 then
        updateStatus("ğŸ›ï¸ Rods yang berhasil dibuat:")
        for i, rod in ipairs(self.ClonedRods) do
            updateStatus("   " .. i .. ". " .. rod)
        end
    end
    
    -- Test rods
    updateStatus("\nğŸ§ª TESTING RODS...")
    self:TestRodsFunctionality()
    
    self.Active = false
end

-- FUNCTION 8: TEST RODS FUNCTIONALITY
function RodCloner:TestRodsFunctionality()
    updateStatus("ğŸ”§ TESTING ROD FUNCTIONALITY...")
    
    local backpack = localPlayer:FindFirstChild("Backpack")
    if not backpack then
        updateStatus("âŒ Backpack tidak ditemukan untuk testing")
        return
    end
    
    local rodsFolder = backpack:FindFirstChild("Rods")
    if not rodsFolder then
        updateStatus("âŒ Rods folder tidak ditemukan")
        return
    end
    
    local workingRods = 0
    local totalRods = 0
    
    for _, rod in pairs(rodsFolder:GetChildren()) do
        if rod:IsA("Tool") then
            totalRods = totalRods + 1
            
            -- Cek basic requirements
            local hasHandle = rod:FindFirstChild("Handle") ~= nil
            local hasScript = false
            
            for _, script in pairs(rod:GetDescendants()) do
                if script:IsA("Script") or script:IsA("LocalScript") then
                    hasScript = true
                    break
                end
            end
            
            if hasHandle and hasScript then
                workingRods = workingRods + 1
                updateStatus("   âœ… " .. rod.Name .. " - FUNCTIONAL")
            else
                updateStatus("   âŒ " .. rod.Name .. " - BROKEN (No Handle/Script)")
            end
        end
    end
    
    updateStatus("ğŸ“‹ TEST RESULT: " .. workingRods .. "/" .. totalRods .. " rods functional")
end

-- ================================================================================= --
--[[ BAGIAN 3: ROD CLONER UI ]]
-- ================================================================================= --

local Window = Rayfield:CreateWindow({
    Name = "ğŸ­ FISH IT ROD CLONER",
    LoadingTitle = "Loading Real Rod Cloner...",
    LoadingSubtitle = "CLONE ROD ASLI + FUNCTIONAL",
    Theme = "Default",
    ToggleUIKeybind = "K"
})

-- TAB UTAMA: ROD CLONER
local MainTab = Window:CreateTab("ğŸ­ Rod Cloner")
MainTab:CreateLabel("CLONE ROD ASLI DARI GAME - 100% FUNCTIONAL")

MainTab:CreateButton({
    Name = "ğŸš€ AUTO: Clone Semua Rod Functional",
    Callback = function()
        RodCloner:CreateAllRods()
    end
})

MainTab:CreateSection("Setup & Tools")

MainTab:CreateButton({
    Name = "ğŸ’ Setup Backpack Manager",
    Callback = function()
        RodCloner:SetupBackpackManager()
    end
})

MainTab:CreateButton({
    Name = "ğŸ” Find Rod Templates",
    Callback = function()
        RodCloner:FindRealRodTemplates()
    end
})

MainTab:CreateButton({
    Name = "ğŸ§ª Test Rods Functionality",
    Callback = function()
        RodCloner:TestRodsFunctionality()
    end
})

MainTab:CreateSection("Clone Rod Spesifik")

-- Buat tombol untuk rod spesifik
for _, rodName in ipairs(RodCloner.AvailableRods) do
    MainTab:CreateButton({
        Name = "ğŸ”§ Clone " .. rodName,
        Callback = function()
            RodCloner:CloneOrCreateRod(rodName)
        end
    })
end

-- TAB: ROD MANAGER
local ManagerTab = Window:CreateTab("ğŸ’ Rod Manager")
ManagerTab:CreateLabel("Rod Management & Tools")

ManagerTab:CreateButton({
    Name = "ğŸ” List Rods di Backpack",
    Callback = function()
        updateStatus("ğŸ” RODS DI BACKPACK:")
        
        local backpack = localPlayer:FindFirstChild("Backpack")
        if backpack then
            local rodsFolder = backpack:FindFirstChild("Rods")
            if rodsFolder then
                for _, rod in pairs(rodsFolder:GetChildren()) do
                    if rod:IsA("Tool") then
                        local hasHandle = rod:FindFirstChild("Handle") ~= nil
                        local scriptCount = 0
                        
                        for _ in pairs(rod:GetDescendants()) do
                            if script:IsA("Script") or script:IsA("LocalScript") then
                                scriptCount = scriptCount + 1
                            end
                        end
                        
                        updateStatus("ğŸ£ " .. rod.Name .. " - Handle: " .. tostring(hasHandle) .. " - Scripts: " .. scriptCount)
                    end
                end
            else
                updateStatus("âŒ Rods folder tidak ditemukan")
            end
        else
            updateStatus("âŒ Backpack tidak ditemukan")
        end
    end
})

ManagerTab:CreateButton({
    Name = "ğŸ”„ Refresh All Rods",
    Callback = function()
        updateStatus("ğŸ”„ REFRESHING RODS...")
        
        -- Unequip tools dulu
        local character = localPlayer.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:UnequipTools()
            end
        end
        
        task.wait(1)
        updateStatus("âœ… Rods refreshed!")
    end
})

ManagerTab:CreateButton({
    Name = "ğŸ—‘ï¸ Clean Broken Rods",
    Callback = function()
        updateStatus("ğŸ—‘ï¸ CLEANING BROKEN RODS...")
        
        local backpack = localPlayer:FindFirstChild("Backpack")
        if backpack then
            local rodsFolder = backpack:FindFirstChild("Rods")
            if rodsFolder then
                local removed = 0
                for _, rod in pairs(rodsFolder:GetChildren()) do
                    if rod:IsA("Tool") then
                        if not rod:FindFirstChild("Handle") then
                            rod:Destroy()
                            removed = removed + 1
                        end
                    end
                end
                updateStatus("âœ… Removed " .. removed .. " broken rods")
            end
        end
    end
})

-- Inisialisasi
updateStatus("ğŸ­ FISH IT REAL ROD CLONER LOADED!")
updateStatus("ğŸ¯ System akan CLONE rod asli dari game!")
updateStatus("ğŸ”§ Rod akan 100% functional dengan Handle & Script!")

-- Auto setup
task.spawn(function()
    task.wait(3)
    updateStatus("ğŸ”§ Auto setup backpack...")
    RodCloner:SetupBackpackManager()
end)
